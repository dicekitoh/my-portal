<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>秒ぴったり待ち合わせタイマー</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, 'Helvetica Neue', sans-serif;
  background: #0a0a1a;
  color: #e0e0e0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  transition: background 0.3s;
}

/* ===== 入力モード ===== */
.input-mode {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  width: 90%;
  max-width: 400px;
}
.input-mode h1 {
  font-size: 1.4em;
  font-weight: 400;
  color: #ccc;
  letter-spacing: 2px;
}
.time-input {
  font-size: 3.5em;
  font-weight: 700;
  text-align: center;
  background: #111;
  border: 2px solid #333;
  border-radius: 16px;
  color: #4fc3f7;
  padding: 16px 24px;
  width: 100%;
  -webkit-appearance: none;
  letter-spacing: 4px;
}
.time-input:focus {
  outline: none;
  border-color: #4fc3f7;
  box-shadow: 0 0 20px rgba(79,195,247,0.2);
}
.now-label {
  font-size: 1.1em;
  color: #666;
  font-variant-numeric: tabular-nums;
}
.share-btn {
  font-size: 1.3em;
  font-weight: 600;
  background: #4fc3f7;
  color: #000;
  border: none;
  border-radius: 14px;
  padding: 16px 40px;
  width: 100%;
  cursor: pointer;
  letter-spacing: 2px;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.2s;
}
.share-btn:active {
  transform: scale(0.96);
  background: #39a8d8;
}
.share-btn:disabled {
  background: #333;
  color: #666;
}
.preview-url {
  font-size: 0.75em;
  color: #444;
  word-break: break-all;
  text-align: center;
  line-height: 1.6;
}
.copy-btn {
  font-size: 1em;
  background: transparent;
  color: #4fc3f7;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 10px 24px;
  cursor: pointer;
  letter-spacing: 1px;
  -webkit-tap-highlight-color: transparent;
}
.copy-btn:active { background: #1a1a2e; }
.toast {
  position: fixed;
  bottom: 60px;
  background: #333;
  color: #fff;
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 0.9em;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* ===== カウントダウンモード ===== */
body.warn { background: #1a0a00; }
body.danger { background: #2a0000; }
body.flash { animation: flash 0.5s ease; }
body.arrived { background: #001a00; }

@keyframes flash {
  0%, 100% { background: #2a0000; }
  50% { background: #ff0000; }
}

.countdown-mode { display: none; flex-direction: column; align-items: center; }
.label {
  font-size: 1.2em;
  color: #888;
  margin-bottom: 8px;
  letter-spacing: 2px;
}
.target-time {
  font-size: 2.5em;
  font-weight: 300;
  color: #4fc3f7;
  margin-bottom: 40px;
  letter-spacing: 4px;
}
.countdown {
  font-size: 8em;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: 4px;
  line-height: 1;
  margin-bottom: 12px;
  transition: color 0.3s;
}
.countdown.warn { color: #ffab40; }
.countdown.danger { color: #ff5252; }
.countdown.arrived { color: #69f0ae; }

.sub-seconds {
  font-size: 2em;
  font-variant-numeric: tabular-nums;
  color: #666;
  margin-bottom: 40px;
}
.message {
  font-size: 1.8em;
  font-weight: 300;
  letter-spacing: 2px;
  min-height: 1.5em;
}
.message.arrived { color: #69f0ae; font-weight: 700; }
.message.over { color: #ff5252; }

.now-clock {
  position: fixed;
  bottom: 20px;
  right: 24px;
  font-size: 1.1em;
  color: #555;
  font-variant-numeric: tabular-nums;
}
.progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  height: 4px;
  background: #4fc3f7;
  transition: width 0.1s linear, background 0.3s;
}
.progress-bar.warn { background: #ffab40; }
.progress-bar.danger { background: #ff5252; }

.sender-name {
  font-size: 1em;
  color: #555;
  margin-top: 20px;
  letter-spacing: 1px;
}
</style>
</head>
<body>

<!-- ===== 入力モード（送信者用） ===== -->
<div class="input-mode" id="inputMode">
  <h1>到着予定時刻</h1>
  <div class="now-label" id="nowLabel">現在 --:--</div>
  <input type="time" class="time-input" id="timeInput" step="60">
  <button class="share-btn" id="shareBtn" disabled>iMessageで送信</button>
  <button class="copy-btn" id="copyBtn" style="display:none">URLをコピー</button>
  <div class="preview-url" id="previewUrl"></div>
  <div class="toast" id="toast"></div>
</div>

<!-- ===== カウントダウンモード（受信者用） ===== -->
<div class="countdown-mode" id="countdownMode">
  <div class="progress-bar" id="progress"></div>
  <div class="label">到着予定時刻</div>
  <div class="target-time" id="target">--:--:--</div>
  <div class="countdown" id="countdown">--:--:--</div>
  <div class="sub-seconds" id="subsec">.000</div>
  <div class="message" id="message"></div>
  <div class="sender-name" id="senderName"></div>
  <div class="now-clock" id="now">現在 --:--:--</div>
</div>

<script>
(function() {
  const BASE = location.origin + location.pathname;
  const params = new URLSearchParams(location.search);
  const meetParam = params.get('meet');
  const pad = (n, d=2) => String(n).padStart(d, '0');

  // === モード判定 ===
  if (meetParam) {
    startCountdown(meetParam);
  } else {
    startInputMode();
  }

  // ==============================
  //  入力モード（送信者）
  // ==============================
  function startInputMode() {
    const inputMode = document.getElementById('inputMode');
    const timeInput = document.getElementById('timeInput');
    const shareBtn = document.getElementById('shareBtn');
    const copyBtn = document.getElementById('copyBtn');
    const previewUrl = document.getElementById('previewUrl');
    const nowLabel = document.getElementById('nowLabel');
    const toast = document.getElementById('toast');

    inputMode.style.display = 'flex';

    // 現在時刻を表示（リアルタイム）
    function updateNow() {
      const n = new Date();
      nowLabel.textContent = `現在 ${pad(n.getHours())}:${pad(n.getMinutes())}:${pad(n.getSeconds())}`;
      requestAnimationFrame(updateNow);
    }
    updateNow();

    // デフォルト: 現在時刻の10分後（切り上げ5分単位）
    const def = new Date(Date.now() + 10 * 60000);
    const defMin = Math.ceil(def.getMinutes() / 5) * 5;
    def.setMinutes(defMin, 0, 0);
    timeInput.value = `${pad(def.getHours())}:${pad(def.getMinutes())}`;

    updatePreview();

    timeInput.addEventListener('input', updatePreview);
    timeInput.addEventListener('change', updatePreview);

    function buildUrl() {
      const v = timeInput.value;
      if (!v) return null;
      return `${BASE}?meet=${v}:00`;
    }

    function updatePreview() {
      const url = buildUrl();
      if (url) {
        shareBtn.disabled = false;
        copyBtn.style.display = '';
        previewUrl.textContent = url;
      } else {
        shareBtn.disabled = true;
        copyBtn.style.display = 'none';
        previewUrl.textContent = '';
      }
    }

    // 共有ボタン（Web Share API → iMessage等）
    shareBtn.addEventListener('click', async function() {
      const url = buildUrl();
      const v = timeInput.value;
      if (!url) return;

      const text = `${v}に到着します`;

      if (navigator.share) {
        try {
          await navigator.share({ title: '到着予定', text: text, url: url });
        } catch(e) {
          // ユーザーがキャンセルした場合は何もしない
        }
      } else {
        // Web Share非対応: URLスキームでiMessage起動
        const body = encodeURIComponent(`${text}\n${url}`);
        window.open(`sms:&body=${body}`, '_self');
      }
    });

    // コピーボタン
    copyBtn.addEventListener('click', function() {
      const url = buildUrl();
      if (!url) return;
      const v = timeInput.value;
      const full = `${v}に到着します\n${url}`;
      navigator.clipboard.writeText(full).then(() => {
        showToast('コピーしました');
      }).catch(() => {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = full;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('コピーしました');
      });
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  }

  // ==============================
  //  カウントダウンモード（受信者）
  // ==============================
  function startCountdown(timeStr) {
    document.getElementById('countdownMode').style.display = 'flex';
    document.getElementById('inputMode').style.display = 'none';

    const parts = timeStr.split(':');
    const h = parseInt(parts[0], 10) || 0;
    const m = parseInt(parts[1], 10) || 0;
    const s = parseInt(parts[2], 10) || 0;

    const now = new Date();
    const targetDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s, 0);

    const targetEl = document.getElementById('target');
    const countdownEl = document.getElementById('countdown');
    const subsecEl = document.getElementById('subsec');
    const messageEl = document.getElementById('message');
    const nowEl = document.getElementById('now');
    const progressEl = document.getElementById('progress');
    const body = document.body;

    targetEl.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;

    const initialRemaining = Math.max(targetDate.getTime() - Date.now(), 1);
    let lastFlashSec = -1;

    function tick() {
      const now = new Date();
      const diffMs = targetDate.getTime() - now.getTime();
      const absDiff = Math.abs(diffMs);

      nowEl.textContent = `現在 ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}.${pad(now.getMilliseconds(), 3)}`;

      if (diffMs > 0) {
        const pct = Math.max(0, Math.min(100, ((initialRemaining - diffMs) / initialRemaining) * 100));
        progressEl.style.width = pct + '%';
      } else {
        progressEl.style.width = '100%';
      }

      if (diffMs > 0) {
        const totalSec = Math.ceil(diffMs / 1000);
        const hours = Math.floor(totalSec / 3600);
        const mins = Math.floor((totalSec % 3600) / 60);
        const secs = totalSec % 60;
        const ms = 1000 - (diffMs % 1000);

        countdownEl.textContent = hours > 0
          ? `${pad(hours)}:${pad(mins)}:${pad(secs)}`
          : `${pad(mins)}:${pad(secs)}`;
        subsecEl.textContent = `.${pad(ms % 1000, 3)}`;

        body.className = '';
        countdownEl.className = 'countdown';
        progressEl.className = 'progress-bar';

        if (totalSec <= 3) {
          body.className = 'danger';
          countdownEl.className = 'countdown danger';
          progressEl.className = 'progress-bar danger';
          const currentSec = Math.ceil(diffMs / 1000);
          if (currentSec !== lastFlashSec) {
            lastFlashSec = currentSec;
            body.classList.add('flash');
            setTimeout(() => body.classList.remove('flash'), 500);
          }
          messageEl.textContent = '';
        } else if (totalSec <= 10) {
          body.className = 'warn';
          countdownEl.className = 'countdown warn';
          progressEl.className = 'progress-bar warn';
          messageEl.textContent = 'まもなく到着';
          messageEl.className = 'message';
        } else if (totalSec <= 60) {
          messageEl.textContent = 'あと1分以内';
          messageEl.className = 'message';
        } else {
          messageEl.textContent = '';
          messageEl.className = 'message';
        }
      } else if (absDiff < 1000) {
        countdownEl.textContent = '00:00';
        subsecEl.textContent = '.000';
        countdownEl.className = 'countdown arrived';
        body.className = 'arrived';
        messageEl.textContent = '到着しました！';
        messageEl.className = 'message arrived';
      } else {
        const overSec = Math.floor(absDiff / 1000);
        const overMin = Math.floor(overSec / 60);
        const overS = overSec % 60;
        countdownEl.textContent = overMin > 0
          ? `+${pad(overMin)}:${pad(overS)}`
          : `+${pad(overS)}`;
        subsecEl.textContent = '';
        countdownEl.className = 'countdown danger';
        body.className = 'danger';
        messageEl.textContent = `${overSec}秒 経過`;
        messageEl.className = 'message over';
      }

      requestAnimationFrame(tick);
    }

    requestAnimationFrame(tick);
  }
})();
</script>
</body>
</html>
